worker_processes 1;
daemon off;

error_log <%= ENV["APP_ROOT"] %>/nginx/logs/error.log;
events { worker_connections 1024; }

http {
  log_format cloudfoundry '$http_x_forwarded_for - $http_referer - [$time_local] "$request" $status $body_bytes_sent $request_time';
  access_log <%= ENV["APP_ROOT"] %>/nginx/logs/access.log cloudfoundry;
  default_type application/octet-stream;
  include mime.types;
  sendfile on;

  gzip on;
  gzip_disable "msie6";
  gzip_comp_level 2;
  gzip_min_length 500;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gzip_types text/plain text/css text/js text/xml text/javascript application/javascript application/x-javascript application/json application/xml application/xml+rss;

  tcp_nopush on;
  keepalive_timeout 30;
  port_in_redirect off; 
  keepalive_disable none;
  etag on;
  if_modified_since exact;

  # The YaaS landing page itself
  # only serves resources from it's canonical server name
  server {
    listen   <%= ENV["PORT"] %>;
    server_name   techne.yaas.io techne.stage.yaas.io;

    location / {
      root <%= ENV["APP_ROOT"] %>/public;
      index index.html index.htm Default.htm;

      location /error/ {
        internal;
      }

      location ~* \.(?:ico|css|js|gif|jpe?g|png|woff|svg)$ {
        # Some basic cache-control for static files to be sent to the browser
        expires 24h;
        add_header Pragma public;
        add_header Cache-Control "public, must-revalidate, proxy-revalidate";
      }

      # when called through plain http, always redirect to ssl site
      if ($http_x_forwarded_proto = http) {
        return 301 https://$host$request_uri;
      }
    }

    rewrite ^/home/?(.*)$ /$1 permanent;
    rewrite ^/globalressources/(.*)$ /globalresources/$1 permanent;
    
    # location /terms-of-use.html {
		#   rewrite ^/.* /legal/sap-hybris-as-a-service-account-terms-of-use_v1.html permanent;
		#}
		#location /legal/yaas-framecontract-commercial.html {
		#   rewrite ^/.* /legal/sap-hybris-as-a-service-organization-terms-of-use_v1.html permanent;
		#}

    error_page 403 /error/error.html;
    error_page 404 /error/error.html;
    error_page 500 502 503 504 /error/error.html;
  }

  # Name variations of the YaaS landing page
  # just redirect them to the corresponding resource on the canonical server name
  server {
    listen   <%= ENV["PORT"] %>;
    server_name   techne.yaas.io techne.stage.yaas.io;

    return   301   https://www.$host$request_uri;
  }

  # Catch all server
  # redirect all other traffic to the YaaS landing page home
  # (e.g. calls by IP, wildcard sub-domains, etc)
  server {
    listen   <%= ENV["PORT"] %>   default_server;
    server_name   default;

    return   301   https://techne.yaas.io/;
  }

}
